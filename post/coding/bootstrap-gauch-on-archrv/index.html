<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>给 gauche 写个 bootstrap 脚本 - sh1marin's blog</title><meta name=theme-color><meta name=description content="前言 上周在给 Arch 打包的时候看到了一个还没进仓库的包 gauche 需要 bootstrap。 因为我以前没打过 bootstrap 的包，有点想学，遂尝试挑战了一下。 gauche 的 x86 版本的 PKGBUILD"><meta name=author content="sh1marin"><link rel="preload stylesheet" as=style href=https://blog.sh1mar.in/main.min.css><script defer src=https://blog.sh1mar.in/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://blog.sh1mar.in/theme.png><link rel=preload as=image href=https://blog.sh1mar.in/github.svg><link rel=preload as=image href=https://blog.sh1mar.in/rss.svg><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<link rel=icon href=https://blog.sh1mar.in/favicon.ico><link rel=apple-touch-icon href=https://blog.sh1mar.in/apple-touch-icon.png><meta name=generator content="Hugo 0.112.3"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><meta property="og:title" content="给 gauche 写个 bootstrap 脚本"><meta property="og:description" content="前言 上周在给 Arch 打包的时候看到了一个还没进仓库的包 gauche 需要 bootstrap。 因为我以前没打过 bootstrap 的包，有点想学，遂尝试挑战了一下。 gauche 的 x86 版本的 PKGBUILD"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sh1mar.in/post/coding/bootstrap-gauch-on-archrv/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-02-13T00:00:00+08:00"><meta property="article:modified_time" content="2022-02-13T00:00:00+08:00"><meta itemprop=name content="给 gauche 写个 bootstrap 脚本"><meta itemprop=description content="前言 上周在给 Arch 打包的时候看到了一个还没进仓库的包 gauche 需要 bootstrap。 因为我以前没打过 bootstrap 的包，有点想学，遂尝试挑战了一下。 gauche 的 x86 版本的 PKGBUILD"><meta itemprop=datePublished content="2022-02-13T00:00:00+08:00"><meta itemprop=dateModified content="2022-02-13T00:00:00+08:00"><meta itemprop=wordCount content="2422"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="给 gauche 写个 bootstrap 脚本"><meta name=twitter:description content="前言 上周在给 Arch 打包的时候看到了一个还没进仓库的包 gauche 需要 bootstrap。 因为我以前没打过 bootstrap 的包，有点想学，遂尝试挑战了一下。 gauche 的 x86 版本的 PKGBUILD"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://blog.sh1mar.in>sh1marin's blog</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/Avimitin target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://blog.sh1mar.in/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">给 gauche 写个 bootstrap 脚本</h1><div class="text-sm antialiased opacity-60"><time>Feb 13, 2022</time>
<span class=mx-1>&#183;</span>
<span>sh1marin</span></div></header><section><h2 id=前言>前言</h2><p>上周在给 Arch 打包的时候看到了一个还没进仓库的包 gauche 需要 bootstrap。
因为我以前没打过 bootstrap 的包，有点想学，遂尝试挑战了一下。</p><p>gauche 的 x86 版本的 PKGBUILD 在
<a href=https://github.com/archlinux/svntogit-community/blob/packages/gauche/trunk/PKGBUILD>GitHub</a>
上可以找到，我修改后的 PKGBUILD 在
<a href=https://github.com/felixonmars/archriscv-packages/pull/804>PR #804</a> 。
现在还没有 merge，请以肥猫 review 后的版本为准。
如果你对这篇文章感兴趣，推荐你对照着这两个 PKGBUILD 文件来阅读。</p><h2 id=准备>准备</h2><p>首先打开 gauche 这个包的 PKGBUILD 文件查看一下依赖。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>depends<span style=color:#fe8019>=(</span>libatomic_ops libxcrypt slib<span style=color:#fe8019>)</span>
</span></span><span style=display:flex><span>makedepends<span style=color:#fe8019>=(</span>autoconf gauche git<span style=color:#fe8019>)</span>
</span></span></code></pre></div><blockquote><p>depends 数组声明这个包构建和运行时的依赖，而 makedepends 声明
这个包构建时的依赖。</p></blockquote><p>其中 depends 数组里的依赖 RISCV 的仓库里都有了，makedepends 里的
git 和 autoconf RISCV 仓库里也有。只差 gauche 自己了。</p><p>如果像我一样没听说过 bootstrap ，你可能会觉得很奇怪，怎么要靠自己来编译
自己呢？这不是陷入了先有蛋还是先有鸡的悖论中了吗？</p><p>实际上有些软件会尝试用旧版本的自己去辅助构建，
或者用旧版本的自己来编译新版本的自己。比如 Rust，你在编译新版本的
rustc 的时候会需要用到旧版的 rustc。
假如运气不好遇到几个版本都不兼容的问题，
可能会导致你需要一个版本一个版本的往上编译。</p><p>所以当某个编译器可以自编译了之后，
后续版本就会依赖自己了。我即将要尝试的 gauche 就是如此，
他写了一些 scm 脚本来辅助编译，
这些 scm 脚本依赖兼容语法的 gauche 解释器来执行。</p><blockquote><p>这种的 bootstrap 是最简单的一种，即该软件本身就是可以不依赖自身编译出来。
比较麻烦的是那些完全自举了的，一般有两种思路。</p><ol><li>一种是，从他没有完成自举的版本一个个编译器过去，比如 Rust 就要从最初的
OCaml 原型编译器开始编译，GCC 需要从最后的 C 版本甚至于最初的 ASM 开始编译
（不过这两个实际上可以采取下面说的第二种方法）</li><li>第二种方法是在其他架构交叉编译，典型例子是 GCC，Rust 和 JDK。</li></ol><p>&ndash; <a href=https://github.com/CoelacanthusHex>Coelacanthus</a></p></blockquote><p>所以我需要写一个新的构建脚本来构建一个新的包，给 gauche 这个包提供他自己。</p><p>依赖理清了，下一步要做的是找到 gauche 的文档和源码。
打包的人通常都会在 PKGBUILD 的 url 变量里声明官网。
在 source 数组里的地址也可以提供源码的位置。</p><p>在 gauche 的 PKGBUILD 里是这样的：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>url<span style=color:#fe8019>=</span><span style=color:#b8bb26>&#39;https://practical-scheme.net/gauche/&#39;</span>
</span></span><span style=display:flex><span>source<span style=color:#fe8019>=(</span><span style=color:#b8bb26>&#34;</span>$pkgname<span style=color:#b8bb26>::git+https://github.com/shirok/Gauche#commit=d028d2e291957b066572aae4a76dbd7a75a528d7&#34;</span><span style=color:#fe8019>)</span>
</span></span></code></pre></div><p>从这两个声明能拿到 gauche 的网站是 <a href=https://practical-scheme.net/gauche/>https://practical-scheme.net/gauche/</a>，
而源码在 GitHub 上托管 <a href=https://github.com/shirok/Gauche>https://github.com/shirok/Gauche</a>。</p><p>翻阅 gauche 网站，我发现不依赖 gauche 进行编译并不难。
在 download 的页面里有提供源码的 tarball 文件，
只需要简单的跑个 <code>make</code> 就可以编译了。</p><p>然后在 gauche 的 README 文件里，我发现他强调了一句：</p><blockquote><p>" If it is your first time to build Gauche, you should start from the release
tarball instead of git clone."</p></blockquote><p>这意味着我们需要把 source 里的源码地址修改一下，
更换成 release 页的地址。</p><p>看起来大概没什么问题了，于是我先把源码丢到 QEMU 的 RISCV 虚拟机里尝试
<code>make && make check</code>。</p><h2 id=脚本变量>脚本变量</h2><p>在虚拟机里编译和测试都顺利的完成之后，下一步就是写 PKGBUILD。</p><p>首先把原来 x86 的 PKGBUILD 拷贝一份出来，把原来的 pkgname 存到另外一个变量里，
然后填上新的名字。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>_pkgname<span style=color:#fe8019>=</span>gauche
</span></span><span style=display:flex><span>pkgname<span style=color:#fe8019>=</span>gauche-bootstrap-riscv64
</span></span></code></pre></div><p>因为这是一个新的包，这里我把 pkgrel 改为 1。
接着把 makedepends 里的 gauche 给删了，我给他再加上两个新变量 provides 和 conflicts，
表明这个包可以提供 gauche 包，而且与 gauche 包冲突。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>provides<span style=color:#fe8019>=(</span>gauche<span style=color:#fe8019>)</span>
</span></span><span style=display:flex><span>conflicts<span style=color:#fe8019>=(</span>gauche<span style=color:#fe8019>)</span>
</span></span></code></pre></div><p>因为源地址我要改成 release 里的 tarball 文件，只需要 curl 下载就行了，
所以再把 makedepends 里的 git 依赖删掉。</p><p>最后把 arch 变量改为 &lsquo;riscv64&rsquo;，表明这个包只能在 64 位 RISCV 环境下构建，
以及在 pkgdesc 变量里补充一句 &ldquo;(for riscv64 bootstrapping)"，前半部分就完成了。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>arch<span style=color:#fe8019>=(</span>riscv64<span style=color:#fe8019>)</span>
</span></span><span style=display:flex><span>pkgdesc<span style=color:#fe8019>=</span><span style=color:#b8bb26>&#39;R7RS Scheme implementation (includes gosh) (for riscv64 bootstrapping)&#39;</span>
</span></span></code></pre></div><p>接下来就是替换源文件地址。分析了一下这个作者发 release 文件的格式通常是：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>https://github.com/shirok/Gauche/releases/download/release0_9_11/Gauche-0.9.11.tgz
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>https://github.com/shirok/Gauche/releases/download/{tag}/Gauche-{version}.tgz
</span></span></code></pre></div><p>这里的 version 他常用 <code>X.Y.Z</code> 的格式，但他打 tag 的格式却是 <code>releaseX_Y_Z</code> 这样的格式。
为了复用变量，这里我们只好对 pkgver 这个变量的值进行一些文本替换操作。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>source<span style=color:#fe8019>=(</span><span style=color:#b8bb26>&#34;</span>$_pkgname<span style=color:#b8bb26>-</span>$pkgver<span style=color:#b8bb26>.tgz&#34;</span>::https://github.com/shirok/Gauche/releases/download/release<span style=color:#b8bb26>${</span>pkgver//<span style=color:#b8bb26>\.</span>/_<span style=color:#b8bb26>}</span>/Gauche-$pkgver.tgz<span style=color:#fe8019>)</span>
</span></span></code></pre></div><p>双冒号的前半部分定义了下载后的文件名，后半部分指定了下载路径。
我用 sed 把这里的 <code>.</code> 换成了 <code>_</code>。经过替换后就能获得正确的文件地址：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>https://github.com/shirok/Gauche/releases/download/release0_9_11/Gauche-0.9.11.tgz
</span></span></code></pre></div><p>由于是新文件，需要跑一下 <code>updpkgsums</code> 这个脚本给源文件生成一个 sha256sums 用于校验文件。</p><h2 id=脚本函数>脚本函数</h2><p>这些必要的变量写完之后，接下来就是修改 <code>build</code> 和 <code>prepare</code> 这两个函数。</p><p>由于我把 source 数组里的文件名改成了 <code>$_pkgname-$pkgver</code> 的形式，
首先要把 cd 给改了。这里的 gosh 是 gauche 的可执行文件名，
因为我 bootstrapping 没有 gosh 给我用，这一行可以删了。
而 CFLAGS 是 LTO 的时候的优化 flag，在实际编译测试中没有需要，所以我也删了。
<code>DIST gen</code> 也是依赖 gauche 解释的脚本，同样也删了。
最后剩下的 configure 和 make 就是最终需要的编译命令。</p><p>package 函数里只需要修改一下 cd 的目录即可。</p><h2 id=问题>问题</h2><p>实际跑 archbuild 的时候遇到了两个问题。</p><ol><li>在 package 函数执行的过程中会出现 <code>qemu: unknown option -ftest</code></li><li>在 QEMU 环境里执行 <code>make install</code> 会出现 <code>shared library libgauche.*.so not found</code></li></ol><p>这两个问题花了我一段时间去整明白。第一个问题其实有点怪。
在解释这个问题之前，我先讲一下 <code>package()</code> 函数做了什么事情。
首先会执行 <code>make install-pkg</code> 命令。而这个命令会尝试调用刚新鲜出炉编译好的 <code>gosh</code> 可执行去解释
作者写的 scheme 脚本，然后用这些 scm 脚本去安装 gosh 运行时的库。 <code>-ftest</code> 是 gosh
的一个额外参数，可以让 <code>gosh</code> 在源码目录里运行，而不是尝试在系统目录里找依赖。具体行为
在这个函数里可以看到 <a href=https://github.com/shirok/Gauche/blob/master/src/main.c#L464>main.c#L464</a></p><p>但是为什么 <code>-ftest</code> 参数传给了 QEMU 呢？阅读源码的时候发现，<code>gosh</code> 使用了 glibc 的
<code>getopt</code> 函数来尝试解析命令行参数，当解析到 <code>-f</code> 的时候，把额外的参数传入到
<code>further_option()</code> 函数里 <a href=https://github.com/shirok/Gauche/blob/master/src/main.c#L390>(main.c#390)</a>，
而 <code>further_option()</code> 在遇到 <code>test</code> 参数时，仅仅只是把 <code>test_mode</code>
标志设置为 true 而已 (<a href=https://github.com/shirok/Gauche/blob/master/src/main.c#L311>main.c#311</a>)。</p><p>这个问题没有搞懂源头，但好在瓜瓜提醒了一句可能是 <code>argv[0]</code> 的问题，
我把这个包丢到了 riscv 的主板上跑，确实就成功的出包了。</p><p>第二个问题倒是很快解决了。出现了第一个问题之后，我把构建到一半的文件夹
丢进 QEMU 虚拟机里，想试着手动跑一下，然后 gosh 就报了这个错误。</p><p>翻了一下 <a href=https://stackoverflow.com/questions/15117836/adding-shared-library-path-to-makefile>StackOverflow</a>，
找到了 <code>LD_LIBRARY_PATH</code> 这个变量来帮助设置
运行时链接动态库的路径，然后用 <code>fd 'libgauche' .</code> 这个命令找到
编译好的 so 文件的路径，在手动跑 <code>make install</code> 前提前设置好就行。
编译的过程中 Makefile 会自己 export 这个变量，所以直接运行 PKGBUILD 脚本
不会出现这个问题。</p><h2 id=自举>自举</h2><p>bootstrap 包出包之后，
在 PKGBUILD 的同目录下会有打包好的同名 <code>.pkg.tar.zst</code> 文件，
把这个文件和 x86 上的 gauche PKGBUILD 文件放在一起，在跑 archbuild
的时候带上参数 <code>-I gauche-bootstrap-riscv64-ver.pkg.tar.zst</code>。
这个参数会传给 <code>makechrootpkg</code>，向 chroot 环境添加这个包。这样 gauche
包就能找到 gauche 依赖了。</p></section><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://blog.sh1mar.in/post/tools/osu_on_arch/><span class=mr-1.5>←</span><span>在 Arch Linux 上玩 osu stable</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://blog.sh1mar.in/post/ideology/summary_for_2021/><span>我的忏悔 2021</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://blog.sh1mar.in>sh1marin's blog</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>