<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>使用 Python 实现 JSON Web Token - sh1marin's blog</title><meta name=theme-color><meta name=description content="前言
涉及到无状态鉴权时，Token 是比较好的验证用户身份的方案，而 Token 如何制作也是一个设计难点。只是一个 Token 去下载模块又增加依赖的负担，于是我去学习了 JWT(JSON Web Token) 的设计方式。"><meta name=author content="sh1marin's blog"><link rel="preload stylesheet" as=style href=https://blog.sh1mar.in/main.min.css><script defer src=https://blog.sh1mar.in/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://blog.sh1mar.in/theme.png><link rel=preload as=image href=https://blog.sh1mar.in/github.svg><link rel=preload as=image href=https://blog.sh1mar.in/rss.svg><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<link rel=icon href=https://blog.sh1mar.in/favicon.ico><link rel=apple-touch-icon href=https://blog.sh1mar.in/apple-touch-icon.png><meta name=generator content="Hugo 0.112.3"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><meta property="og:title" content="使用 Python 实现 JSON Web Token"><meta property="og:description" content="前言
涉及到无状态鉴权时，Token 是比较好的验证用户身份的方案，而 Token 如何制作也是一个设计难点。只是一个 Token 去下载模块又增加依赖的负担，于是我去学习了 JWT(JSON Web Token) 的设计方式。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sh1mar.in/post/coding/%E7%94%A8python%E5%AE%9E%E7%8E%B0jwt/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-09-19T00:00:00+08:00"><meta property="article:modified_time" content="2020-09-19T00:00:00+08:00"><meta itemprop=name content="使用 Python 实现 JSON Web Token"><meta itemprop=description content="前言
涉及到无状态鉴权时，Token 是比较好的验证用户身份的方案，而 Token 如何制作也是一个设计难点。只是一个 Token 去下载模块又增加依赖的负担，于是我去学习了 JWT(JSON Web Token) 的设计方式。"><meta itemprop=datePublished content="2020-09-19T00:00:00+08:00"><meta itemprop=dateModified content="2020-09-19T00:00:00+08:00"><meta itemprop=wordCount content="1225"><meta itemprop=keywords content="python,web,jwt,"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Python 实现 JSON Web Token"><meta name=twitter:description content="前言
涉及到无状态鉴权时，Token 是比较好的验证用户身份的方案，而 Token 如何制作也是一个设计难点。只是一个 Token 去下载模块又增加依赖的负担，于是我去学习了 JWT(JSON Web Token) 的设计方式。"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://blog.sh1mar.in>sh1marin's blog</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/Avimitin target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://blog.sh1mar.in/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">使用 Python 实现 JSON Web Token</h1><div class="text-sm antialiased opacity-60"><time>Sep 19, 2020</time></div></header><section><h2 id=前言>前言</h2><p>涉及到无状态鉴权时，<code>Token</code> 是比较好的验证用户身份的方案，而 <code>Token</code> 如何制作也是一个设计难点。只是一个 <code>Token</code> 去下载模块又增加依赖的负担，于是我去学习了 <code>JWT(JSON Web Token)</code> 的设计方式。</p><h2 id=jwt-简介>JWT 简介</h2><blockquote><p><code>JWT (JSON Web Token)</code> 是一个定义安全信息传输的公开标准(<a href=https://tools.ietf.org/html/rfc7519>RFC 7519</a>)。使用 <code>JWT</code> 标准设计的信息因为其数字签名，都可被验证和信任。</p></blockquote><p><code>JWT</code> 使用 <code>HMAC</code> 算法或者一个 <code>RSA</code> 或 <code>ECDSA</code> 加密的公/私钥来进行签名认证。使用 <code>JWT</code> 可以帮助实现无状态鉴权和 <code>OAuth 2.0</code> 的实现，也可以用来传输信息。</p><h2 id=jwt-结构>JWT 结构</h2><p><code>JWT</code> 由三部分组成：</p><ul><li>Header</li><li>Payload</li><li>Signature</li></ul><p>分别用点 <code>.</code> 隔开组合，一个 JWT 应该长得像下面这样:</p><p><code>xxxx.yyyy.zzzz</code></p><h3 id=header>Header</h3><p><code>header</code> 内包含两个信息，一般来说都应该是相同的，用来告示自己使用的算法如 <code>HS256</code> 。下面是一个 <code>header</code> 的例子：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fb4934>&#34;alg&#34;</span>: <span style=color:#b8bb26>&#34;HS256&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb4934>&#34;typ&#34;</span>: <span style=color:#b8bb26>&#34;JWT&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>然后使用 Base64Url 将这个 <code>JSON</code> 编码。</strong></p><h3 id=payload>Payload</h3><p>Payload 用来装载关于比如用户的信息或其他更多信息，包含三部分：</p><ul><li>Registered claims: 这里是对 <code>Token</code> 的签发的说明，如 <code>Token</code> 签发方，<code>Token</code> 签发时间，有效时间等等。可以在 <a href=https://tools.ietf.org/html/rfc7519#section-4.1>这里</a> 看到更多关于 <em>Registered claims</em> 名词的说明。</li><li>Public claims: 这里可以由签发人随意定义，但是要尽量避开 <code>Registered claims</code> 所用到的专有名词。</li><li>Private claims: 这里可以装载想要使用 <code>Token</code> 分享的信息。</li></ul><p>下面是关于 <code>Payload</code> 的例子：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#fb4934>&#34;iss&#34;</span>: <span style=color:#b8bb26>&#34;Avimitin Studio&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb4934>&#34;exp&#34;</span>: <span style=color:#b8bb26>&#34;1600483010&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb4934>&#34;user&#34;</span>: <span style=color:#b8bb26>&#34;Tom&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#fb4934>&#34;admin&#34;</span>: <span style=color:#fe8019>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>然后使用 Base64Url 将这个 <code>JSON</code> 编码。</strong></p><h3 id=signature>Signature</h3><p>接着使用 <code>HMAC</code> 算法对上面编码的两个 <code>JSON</code> 进行加密：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>HMACSHA256(header_b64<span style=color:#fe8019>+</span><span style=color:#b8bb26>&#34;.&#34;</span><span style=color:#fe8019>+</span>payload_b64, secret_key)
</span></span></code></pre></div><h3 id=组合>组合：</h3><p>将上面三个部分得到的 base64 使用 <code>.</code> 组合起来，就能获得最终的 JWT 了：</p><h2 id=python-实现>Python 实现</h2><p>虽然 <code>JWT</code> 已经有成熟的模块了，但是在一些环境中能够原生实现相比起让用户安装依赖会更加合适一些，于是我根据上面标准，使用自带模块实现了 JWT。大概步骤如下：</p><h3 id=导入包>导入包</h3><p>制作 <code>Token</code> 将需要以下依赖：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#928374;font-style:italic># 加密</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>import</span> hmac
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># 获取时间戳</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>import</span> time
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># base64加密</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>import</span> base64
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># 获取字符</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>import</span> string
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># 比 random 更安全的随机</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>import</span> secrets
</span></span><span style=display:flex><span><span style=color:#928374;font-style:italic># 加密算法</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>from</span> hashlib <span style=color:#fe8019>import</span> sha256
</span></span></code></pre></div><h3 id=base64加密>base64加密</h3><p>因为 <code>Token</code> 常用于 URL中传递，普通的 base64 加密中的 <code>\</code> <code>=</code> 等字符会造成歧义，所以我们需要加工一下：</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>_safe_base64_url_encode</span>(text):
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 判断输入</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>if</span> <span style=color:#fabd2f>isinstance</span>(text, <span style=color:#fabd2f>str</span>):
</span></span><span style=display:flex><span>        text <span style=color:#fe8019>=</span> text<span style=color:#fe8019>.</span>encode(<span style=color:#b8bb26>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#fe8019>elif</span> <span style=color:#fabd2f>isinstance</span>(text, <span style=color:#fabd2f>bytes</span>):
</span></span><span style=display:flex><span>        <span style=color:#fe8019>pass</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#fe8019>raise</span> <span style=color:#fb4934>TypeError</span>(<span style=color:#b8bb26>&#34;Expected string or bytes but got others&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#928374;font-style:italic># 使用urlsafe方法得到无歧义的base64字节</span>
</span></span><span style=display:flex><span>    text_b64 <span style=color:#fe8019>=</span> base64<span style=color:#fe8019>.</span>urlsafe_b64encode(text)
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 用replace方法将字节里的 = 去掉</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> text_b64<span style=color:#fe8019>.</span>replace(<span style=color:#b8bb26>b</span><span style=color:#b8bb26>&#34;=&#34;</span>, <span style=color:#b8bb26>b</span><span style=color:#b8bb26>&#34;&#34;</span>)
</span></span></code></pre></div><h3 id=生成-header>生成 Header</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>header_generate</span>(self):
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 生成 header 之后传递base64加密后的字节 </span>
</span></span><span style=display:flex><span>	header <span style=color:#fe8019>=</span> <span style=color:#b8bb26>&#34;&#34;&#34;{&#34;alg&#34;: &#34;HS256&#34;, &#34;typ&#34;: &#34;jwt&#34;}&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> self<span style=color:#fe8019>.</span>_safe_base64_url_encode(header)
</span></span></code></pre></div><h3 id=生成-payload>生成 Payload</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>payload_generate</span>(self, username: <span style=color:#fabd2f>str</span>, permission: <span style=color:#fabd2f>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 参数名是示例，可以自行调整</span>
</span></span><span style=display:flex><span>    exp <span style=color:#fe8019>=</span> <span style=color:#fabd2f>round</span>(time<span style=color:#fe8019>.</span>time()) <span style=color:#fe8019>+</span> <span style=color:#d3869b>50</span>
</span></span><span style=display:flex><span>    payload <span style=color:#fe8019>=</span> <span style=color:#b8bb26>&#34;&#34;&#34;{&#34;iss&#34;: &#34;Avimitin Studio&#34;, &#34;exp&#34;: &#34;</span><span style=color:#b8bb26>%d</span><span style=color:#b8bb26>&#34;, &#34;user&#34;: &#34;</span><span style=color:#b8bb26>%s</span><span style=color:#b8bb26>&#34;, &#34;admin&#34;: &#34;</span><span style=color:#b8bb26>%s</span><span style=color:#b8bb26>&#34;}&#34;&#34;&#34;</span> <span style=color:#fe8019>%</span> (exp, username, permission)
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> self<span style=color:#fe8019>.</span>_safe_base64_url_encode(payload)
</span></span></code></pre></div><h3 id=生成加密密钥>生成加密密钥</h3><p>加密用的密钥我是用的是一次性密钥的方法，你也可以换成自己熟记的密码串用来解密。</p><ul><li>一次性随机密码串</li></ul><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>_secret_key_generate</span>(<span style=color:#fabd2f>len</span>: <span style=color:#fabd2f>int</span>):
</span></span><span style=display:flex><span>    current_time <span style=color:#fe8019>=</span> <span style=color:#fabd2f>round</span>(time<span style=color:#fe8019>.</span>time())
</span></span><span style=display:flex><span>    combine_text <span style=color:#fe8019>=</span> string<span style=color:#fe8019>.</span>ascii_letters <span style=color:#fe8019>+</span> <span style=color:#fabd2f>str</span>(current_time)
</span></span><span style=display:flex><span>    salt <span style=color:#fe8019>=</span> <span style=color:#b8bb26>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>while</span> <span style=color:#fabd2f>len</span> <span style=color:#fe8019>&gt;</span> <span style=color:#d3869b>0</span>:
</span></span><span style=display:flex><span>        salt <span style=color:#fe8019>+=</span> secrets<span style=color:#fe8019>.</span>choice(combine_text)
</span></span><span style=display:flex><span>        <span style=color:#fabd2f>len</span> <span style=color:#fe8019>-=</span> <span style=color:#d3869b>1</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> salt<span style=color:#fe8019>.</span>encode(<span style=color:#b8bb26>&#34;utf-8&#34;</span>)
</span></span></code></pre></div><ul><li>或者直接换成自己熟记的密码（尽量不要明文）</li></ul><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>_secret_key_generate</span>():
</span></span><span style=display:flex><span>	<span style=color:#fe8019>with</span> <span style=color:#fabd2f>open</span>(<span style=color:#b8bb26>&#34;config/password.json&#34;</span>, <span style=color:#b8bb26>&#34;r&#34;</span>) <span style=color:#fe8019>as</span> password_file:
</span></span><span style=display:flex><span>        <span style=color:#fe8019>return</span> json<span style=color:#fe8019>.</span>loads(password_file)[<span style=color:#b8bb26>&#34;password&#34;</span>]
</span></span></code></pre></div><ul><li>关于 Secrets 模块的<a href=https://docs.python.org/3/library/secrets.html>更多说明</a></li></ul><h3 id=算法加密>算法加密</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>encrypt</span>(key, msg):
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># new 方法生成一个新的HMAC对象，用digest返回加密后的抽样</span>
</span></span><span style=display:flex><span>    sign <span style=color:#fe8019>=</span> hmac<span style=color:#fe8019>.</span>new(key, msg, sha256)<span style=color:#fe8019>.</span>digest()
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> sign
</span></span></code></pre></div><ul><li>关于HMAC的<a href=https://docs.python.org/3/library/hmac.html>更多API说明</a></li></ul><h3 id=最终合成>最终合成</h3><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#fe8019>def</span> <span style=color:#fabd2f>generate</span>(self, username, permission):
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 生成加密用的密钥</span>
</span></span><span style=display:flex><span>    key <span style=color:#fe8019>=</span> self<span style=color:#fe8019>.</span>_secret_key_generate(<span style=color:#d3869b>16</span>)
</span></span><span style=display:flex><span>    <span style=color:#fabd2f>print</span>(<span style=color:#b8bb26>&#34;加密密钥： &#34;</span> <span style=color:#fe8019>+</span> key<span style=color:#fe8019>.</span>decode(<span style=color:#b8bb26>&#34;utf-8&#34;</span>))
</span></span><span style=display:flex><span>	<span style=color:#928374;font-style:italic># 将前两段信息的 base64 用 . 合并起来    </span>
</span></span><span style=display:flex><span>    message <span style=color:#fe8019>=</span> self<span style=color:#fe8019>.</span>header_generate() <span style=color:#fe8019>+</span> <span style=color:#b8bb26>b</span><span style=color:#b8bb26>&#34;.&#34;</span> <span style=color:#fe8019>+</span> self<span style=color:#fe8019>.</span>payload_generate(username, permission)
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 用密钥把message加密</span>
</span></span><span style=display:flex><span>    signature <span style=color:#fe8019>=</span> self<span style=color:#fe8019>.</span>encrypt(key, message)
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 将加密后获得的抽样 base64 加密</span>
</span></span><span style=display:flex><span>    signature_b64 <span style=color:#fe8019>=</span> self<span style=color:#fe8019>.</span>_safe_base64_url_encode(signature)
</span></span><span style=display:flex><span>    part <span style=color:#fe8019>=</span> [message, signature_b64]
</span></span><span style=display:flex><span>    <span style=color:#928374;font-style:italic># 最终把所有的base64合并并解码为 string 字符串</span>
</span></span><span style=display:flex><span>    <span style=color:#fe8019>return</span> <span style=color:#b8bb26>b</span><span style=color:#b8bb26>&#34;.&#34;</span><span style=color:#fe8019>.</span>join(part)<span style=color:#fe8019>.</span>decode(<span style=color:#b8bb26>&#34;utf-8&#34;</span>)
</span></span></code></pre></div><h3 id=输出样例>输出样例</h3><p>最终程序输出样例：</p><pre tabindex=0><code>加密密钥： XWBCv6bT8FXNKV2z

JWT: eyJhbGciOiAiSFMyNTYiLCAidHlwIjogImp3dCJ9.eyJpc3MiOiAiQXZpbWl0aW4gU3R1ZGlvIiwgImV4cCI6ICIxNjAwNDg1Nzc4IiwgInVzZXIiOiAiYXZpbWl0aW4iLCAiYWRtaW4iOiAiVHJ1ZSJ9.Kph2-Qin9Xrd3LwLWX5mOtGiei-1Cp2mtWuhzps3ub0
</code></pre><h2 id=代码样本>代码样本：</h2><p>你可以在我的 <a href=https://github.com/Avimitin/JWTPY>GitHub</a> 看到完整的代码演示。</p></section><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><footer class="mt-12 flex flex-wrap"><a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://blog.sh1mar.in/tags/python>python</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://blog.sh1mar.in/tags/web>web</a>
<a class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]" href=https://blog.sh1mar.in/tags/jwt>jwt</a></footer><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://blog.sh1mar.in/post/coding/%E5%BC%80%E5%8F%91%E8%80%85%E9%9C%80%E8%A6%81%E7%9A%84%E5%A5%BD%E4%B9%A0%E6%83%AF/><span class=mr-1.5>←</span><span>8个开发者需要的好习惯</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://blog.sh1mar.in/post/tools/%E9%BB%91%E8%8B%B9%E6%9E%9C/><span>黑苹果安装教程</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://blog.sh1mar.in>sh1marin's blog</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>