<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Sparsity 初见 - sh1marin's blog</title><meta name=theme-color><meta name=description content="最近在研读 Direct Methods for Sparse Matrices 这本书。 发现国内似乎没有这本书的中文翻译，也很少见对这本书的讨论。 于是打算不让博客落灰，开一个读书笔记系列。 顺便利用博客"><meta name=author content="sh1marin"><link rel="preload stylesheet" as=style href=https://blog.sh1mar.in/main.min.css><script defer src=https://blog.sh1mar.in/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://blog.sh1mar.in/theme.png><link rel=preload as=image href=https://blog.sh1mar.in/github.svg><link rel=preload as=image href=https://blog.sh1mar.in/rss.svg><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<link rel=icon href=https://blog.sh1mar.in/favicon.ico><link rel=apple-touch-icon href=https://blog.sh1mar.in/apple-touch-icon.png><meta name=generator content="Hugo 0.112.3"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><meta property="og:title" content="Sparsity 初见"><meta property="og:description" content="最近在研读 Direct Methods for Sparse Matrices 这本书。 发现国内似乎没有这本书的中文翻译，也很少见对这本书的讨论。 于是打算不让博客落灰，开一个读书笔记系列。 顺便利用博客"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.sh1mar.in/post/sparsity/intro/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-05-12T00:00:00+08:00"><meta property="article:modified_time" content="2023-05-12T00:00:00+08:00"><meta itemprop=name content="Sparsity 初见"><meta itemprop=description content="最近在研读 Direct Methods for Sparse Matrices 这本书。 发现国内似乎没有这本书的中文翻译，也很少见对这本书的讨论。 于是打算不让博客落灰，开一个读书笔记系列。 顺便利用博客"><meta itemprop=datePublished content="2023-05-12T00:00:00+08:00"><meta itemprop=dateModified content="2023-05-12T00:00:00+08:00"><meta itemprop=wordCount content="2097"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Sparsity 初见"><meta name=twitter:description content="最近在研读 Direct Methods for Sparse Matrices 这本书。 发现国内似乎没有这本书的中文翻译，也很少见对这本书的讨论。 于是打算不让博客落灰，开一个读书笔记系列。 顺便利用博客"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://blog.sh1mar.in>sh1marin's blog</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/Avimitin target=_blank rel=me>github</a>
<a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://blog.sh1mar.in/index.xml target=_blank rel=alternate>rss</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">Sparsity 初见</h1><div class="text-sm antialiased opacity-60"><time>May 12, 2023</time>
<span class=mx-1>&#183;</span>
<span>sh1marin</span></div></header><section><blockquote><p>最近在研读 <em>Direct Methods for Sparse Matrices</em> 这本书。
发现国内似乎没有这本书的中文翻译，也很少见对这本书的讨论。
于是打算不让博客落灰，开一个读书笔记系列。
顺便利用博客来帮助我 <a href=https://en.wikipedia.org/wiki/Rubber_duck_debugging>rubberducking</a> 以加深对稀疏矩阵计算概念的记忆。</p></blockquote><h2 id=什么是-sparsity-稀疏>什么是 Sparsity (稀疏)</h2><p>一个矩阵，或一个数组，当它内部大部分元素的值都是 0 的时候，在数值分析中会形容其稀疏。
与 Sparse 对应的，当一个矩阵或数组内大部分元素都是非零的时候，就被称为密集（Dense）。</p><blockquote><p>一个稀疏的矩阵样例</p></blockquote><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span>[
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>1</span>, <span style=color:#d3869b>2</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>],
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>3</span>, <span style=color:#d3869b>4</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>],
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>5</span>, <span style=color:#d3869b>6</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>],
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>7</span>, <span style=color:#d3869b>8</span>],
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>比如，对于一个 4 行 8 列，大小为 32 个元素的矩阵而言，当它有 8 个元素是不为 0 的，
而其他 24 个元素都是 0 的情况下，称这个矩阵的稀疏程度(Sparsity)为 75%，而密集程度为 25%。</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#fabd2f>sparsity</span> <span style=color:#fe8019>=</span> zero_elem_count <span style=color:#fe8019>/</span> matrix_size
</span></span><span style=display:flex><span>   <span style=color:#fe8019>where</span> zero_elem_count <span style=color:#fe8019>=</span> length (filter (<span style=color:#fe8019>==</span> <span style=color:#d3869b>0</span>) matrix)
</span></span><span style=display:flex><span>         matrix_size     <span style=color:#fe8019>=</span> length matrix
</span></span></code></pre></div><h2 id=如何才算稀疏>如何才算稀疏</h2><p>零值元素的比例要到多大才能被称为稀疏(Sparse)呢？这个没有严格定义。
假设有一个矩阵，对其所有的零值进行特殊处理之后，我们能获得存储和计算的收益，
那么就称这个矩阵是稀疏的。反之，如果特殊处理零值之后，对矩阵的计算和存储是效率是
不变的，则称这个矩阵是密集的。</p><h2 id=为什么会存在稀疏>为什么会存在稀疏</h2><p>稀疏这个概念主要用于网络工程和数理分析上。在脑海中想象一片森林，和一条条的树藤，在这个森林里，
每颗树之间可能会有树藤相连，也可能有完全孤立的，没有用树藤和别的树连接的树。
此时来计量树之间的连接性，把完全没有树藤的树记作 0，把只有一条树藤的树也记为 0。
此时想象在这篇森林中的某一块区域，有一排树是完全没有树藤的，
有一排树虽然有树藤，但是只有一条树藤将他们连成一条线，
只有寥寥几颗树会和更多树相连。
那么这一块领域内，就会称这些树是稀疏连接的，这一块领域则是一块稀疏领域。
与之对应的，在记录里，这一片领域对应的值将是大量的 0，只有少量的非零元素</p><p>与之相对的，再想象有一块区域，树和树之间不只是邻接着有树藤连接，而是彼此相连，
一棵树可能会和其他三四棵树相连。那么这一块区域就可以称作是一块密集领域。
与之对应的，这一块领域树的连接性对应的值都会是非零的值。</p><p>这类数值在计算中常常会出现，
理论上来说，压缩稀疏矩阵相对密集矩阵压缩起来会更加简单。
对于计算机而言，
为稀疏的矩阵设计特别的算法和数据结构可以帮助加速计算和提供高效的存储。
直接用普通的矩阵算法来操作稀疏矩阵是不太现实的。</p><h2 id=为什么要专门处理稀疏的矩阵或向量>为什么要专门处理稀疏的矩阵或向量</h2><p>为稀疏矩阵特化存储结构和线性计算的算法，可以显著地提高对矩阵计算的求解时间。
除此之外，从上面的稀疏矩阵样例我们也可以发现，稀疏矩阵里存在着大量的零值，直觉上这些都是可以消除的。
在常见的矩阵计算样例中，矩阵可能会有千甚至上万的行和列，将矩阵的所有值全部存储将占用大量的存储空间
和增加大量不必要的计算。
使用特殊的数据结构来存储非零的元素能显著减少存储空间。</p><p>同时这些特殊化的处理对于之后图的操作也有帮助。</p><h2 id=图与矩阵的关系>图与矩阵的关系</h2><p>任何的方形矩阵都有一个相关的有向图，同时任何一个有向图都有一个相关方形稀疏矩阵。
只要矩阵 A 的 \(i\) 行 \(j\) 列元素 \(a_{ij}\) 是一个非零元素，则代表着在图中，节点 \(i\) 指向
了节点 \(j\)。</p><p>图论用可视化的方式帮助表示矩阵计算后的变更，同时也不要忘记，在线性代数里，矩阵代表着线性变化。</p><h2 id=稀疏矩阵的计算机实现>稀疏矩阵的计算机实现</h2><p>在稀疏矩阵里，通常需要一个特殊的数据结构来存储和访问非零的元素。
具体的实现分成两种：</p><h3 id=支持高效修改的这些操作通常用于构造稀疏矩阵>支持高效修改的（这些操作通常用于构造稀疏矩阵）</h3><h4 id=dok-dictionary-of-keys>DOK (Dictionary of keys)</h4><p>DOK 的实现方式是用字典作为数据结构，用行和列作为 key 来访问对应的矩阵值。
如果结果为空，那么该行列对应的值是零值。</p><ul><li>优点: 构造简单，可以增量更新</li><li>缺点: 无法存储非零值的次序，不便于顺序遍历操作。</li></ul><p>各种属性（参考实现：<a href=https://github.com/scipy/scipy/blob/v1.10.1/scipy/sparse/_dok.py>https://github.com/scipy/scipy/blob/v1.10.1/scipy/sparse/_dok.py</a>）</p><ul><li>矩阵实现：字典</li><li>矩阵大小：内部字典大小，既非零元素的数量</li><li>矩阵访问：使用行列的值为 key 访问内部的字典，如果找不到值就返回 0</li></ul><h4 id=lil-list-of-lists>LIL (List of lists)</h4><blockquote><p>参考： <a href=https://github.com/scipy/scipy/blob/v1.10.1/scipy/sparse/_lil.py>https://github.com/scipy/scipy/blob/v1.10.1/scipy/sparse/_lil.py</a></p></blockquote><p>一个可增量构造矩阵的结构。LIL 实现需要用到两个列表，一个列表代表行，行内每一个列表元素也是一个数组，
数组内存非零元素对应的列的位置。</p><p>另一个列表存实际的非零元素的值，想要获得矩阵 i 行 j 列的元素，需要先访问
row 数组的第 i 个元素取出其存储的所有列的信息，然后枚举遍历找到哪个元素
的值是 j，用这个元素的索引来索引非零元素列表。</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#fabd2f>matrix</span> <span style=color:#fe8019>=</span> [
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>0</span>, <span style=color:#d3869b>1</span>, <span style=color:#d3869b>0</span>],
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>2</span>, <span style=color:#d3869b>4</span>, <span style=color:#d3869b>0</span>],
</span></span><span style=display:flex><span>   [<span style=color:#d3869b>0</span>, <span style=color:#d3869b>0</span>, <span style=color:#d3869b>8</span>],
</span></span><span style=display:flex><span>] <span style=color:#928374;font-style:italic>-- (0, 1; 1), (1, 0; 2), (1, 1; 4), (2, 2; 8)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fabd2f>lil_matrix</span> <span style=color:#fe8019>=</span> <span style=color:#fabd2f>Matrix</span> {
</span></span><span style=display:flex><span>   row <span style=color:#fe8019>=</span> [
</span></span><span style=display:flex><span>      [<span style=color:#d3869b>1</span>],
</span></span><span style=display:flex><span>      [<span style=color:#d3869b>0</span>, <span style=color:#d3869b>1</span>],
</span></span><span style=display:flex><span>      [<span style=color:#d3869b>2</span>],
</span></span><span style=display:flex><span>   ],
</span></span><span style=display:flex><span>   <span style=color:#fe8019>data</span> <span style=color:#fe8019>=</span> [
</span></span><span style=display:flex><span>      [<span style=color:#d3869b>1</span>],
</span></span><span style=display:flex><span>      [<span style=color:#d3869b>2</span>, <span style=color:#d3869b>4</span>],
</span></span><span style=display:flex><span>      [<span style=color:#d3869b>8</span>],
</span></span><span style=display:flex><span>   ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>构建稀疏矩阵用 LIL 很方便，构建结束之后再转换到
算术操作和矩阵操作效率更高的 CSR 或者 CSC 结构。</p><p>优点：</p><ol><li>支持引用矩阵的一段切片 (slicing the matrix)</li><li>更新矩阵的结构更加高效</li><li>内存占用相当的小</li></ol><p>缺点：</p><ol><li>对矩阵的算术计算效率低</li><li>对矩阵元素和列的引用效率和矩阵大小成正比</li></ol><h4 id=coo-coordinate-list>COO (Coordinate list)</h4><p>COO 则更进一步，扩展了上述的数组，用三个列表来表达“行”，“列”，和“值”。比如对于索引 k，
矩阵 <code>row[k]</code>, <code>col[k]</code> 的值就是 <code>data[k]</code>。</p><p>COO 的优点：</p><ul><li>能快速的转换到各种 Sparse 格式</li><li>支持重复读写同一个位置的元素</li><li>能高效转换到 CSR/CSC 格式</li></ul><p>缺点：</p><ul><li>并不能直接性的使用 COO 格式做算术操作</li><li>也不能直接引用内部数据</li></ul><p>COO 的用途：快速构造出稀疏矩阵并转换到 CSR/CSC 格式。</p></section><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://blog.sh1mar.in/post/sparsity/compiler/><span class=mr-1.5>←</span><span>Sparse Compiler</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://blog.sh1mar.in/post/coding/debug-in-chain-calling/><span>Debugging in function chain calling</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://blog.sh1mar.in>sh1marin's blog</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>